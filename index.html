<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khata-Pro</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--primary:#4285F4;--bg:#f8fafc;--red:#EA4335;--slate:#1e293b;}
body{margin:0;padding:10px;background:var(--bg);font-family:Segoe UI;}
.app-title{text-align:center;font-weight:800;color:var(--primary);}
.card{background:#fff;padding:15px;border-radius:18px;margin-bottom:15px;}

.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.summary-card{padding:15px;text-align:center;color:#fff;border-radius:14px}
.month-card{background:#2563eb}
.year-card{background:#16a34a}

.input-row{display:flex;gap:8px;margin-bottom:8px}
input{flex:1;padding:12px;border:1px solid #e2e8f0;border-radius:10px}
.save-btn{flex:1;background:#4285F4;color:#fff;border:none;border-radius:10px}
.rem-btn{flex:.7;border:2px solid red;color:red;background:#fff}

.analysis-zone{background:#edf2f7;padding:15px;border-radius:20px}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;height:120px}
.chart-wrap{height:90px;width:90px;margin:auto}

.history-title{display:flex;justify-content:space-between;
font-weight:800;border-bottom:2px solid #eee;padding-bottom:5px}

.history-table td{padding:10px;border-bottom:1px solid #eee}
.item-a{text-align:right;font-weight:800}
.b-act{border:none;background:none;color:#4285F4}
.b-del{color:red}
</style>
</head>

<body>

<div class="app-title">KHATA-PRO</div>

<div class="summary-grid">
<div class="summary-card month-card">
<div id="mLabel">MONTH</div>
<div id="mTotal">₹0</div>
</div>

<div class="summary-card year-card">
<div id="yLabel">YEAR</div>
<div id="yTotal">₹0</div>
</div>
</div>

<div class="card">
<div class="input-row">
<input id="desc" placeholder="Item">
<input id="amt" type="number" placeholder="Amount">
</div>

<div class="input-row">
<input id="cat" placeholder="Category">
</div>

<div class="input-row">
<button onclick="doSave()" class="save-btn">SAVE</button>
</div>
</div>

<div class="analysis-zone">
<div class="charts-grid">
<div class="chart-wrap"><canvas id="mChart"></canvas></div>
<div class="chart-wrap"><canvas id="yChart"></canvas></div>
</div>
</div>

<div class="card">
<div class="history-title">
<span>History (<span id="filterName">All</span>)</span>
<span onclick="doExcel()">DOWNLOAD</span>
</div>
<table class="history-table">
<tbody id="tableBody"></tbody>
</table>
</div>

<script>

const KEY="khata_pro_v14_final";
let data=JSON.parse(localStorage.getItem(KEY))||[];

let selectedCategory="All";
let mc,yc,editIdx=-1;

window.onload=()=>{initCharts();refresh();};

function initCharts(){

const opt={
plugins:{legend:{display:false}},
cutout:'75%',
onClick:(evt,el,chart)=>{
if(el.length){
selectedCategory=chart.data.labels[el[0].index];
}else{
selectedCategory="All";
}
refresh();
}
};

mc=new Chart(mChart,{type:'doughnut',
data:{labels:[],datasets:[{data:[],
backgroundColor:['#4285F4','#34A853','#FBBC05','#EA4335','#8E44AD']}]},
options:opt});

yc=new Chart(yChart,{type:'doughnut',
data:{labels:[],datasets:[{data:[],
backgroundColor:['#4285F4','#34A853','#FBBC05','#EA4335','#8E44AD']}]},
options:opt});
}

function doSave(){

const d=desc.value;
const a=parseFloat(amt.value);
const c=cat.value||"Other";

if(!d||isNaN(a))return alert("Fill details");

const now=new Date();

const entry={
id:Date.now(),
date:now.toLocaleDateString('en-IN'),
mo:now.getMonth(),
yr:now.getFullYear(),
d,a,c
};

if(editIdx==-1)data.push(entry);
else data[editIdx]=entry;

localStorage.setItem(KEY,JSON.stringify(data));

desc.value="";
amt.value="";

refresh();
}

function refresh(){

const body=tableBody;
body.innerHTML="";

let ms=0,ys=0,mg={},yg={};
const now=new Date();

const filtered=
selectedCategory==="All"
?data
:data.filter(x=>x.c===selectedCategory);

filtered.slice().reverse().forEach((item,i)=>{

body.innerHTML+=`
<tr>
<td>
<b>${item.d}</b><br>
${item.date} | ${item.c}
<br>
<button class="b-act" onclick="doDel(${data.indexOf(item)})">Del</button>
</td>
<td class="item-a">₹${item.a}</td>
</tr>`;

if(item.yr===now.getFullYear()){
ys+=item.a;
yg[item.c]=(yg[item.c]||0)+item.a;

if(item.mo===now.getMonth()){
ms+=item.a;
mg[item.c]=(mg[item.c]||0)+item.a;
}
}
});

mTotal.innerText="₹"+ms;
yTotal.innerText="₹"+ys;

filterName.innerText=selectedCategory;

updateChart(mc,mg);
updateChart(yc,yg);
}

function updateChart(c,d){
c.data.labels=Object.keys(d);
c.data.datasets[0].data=Object.values(d);
c.update();
}

function doDel(i){
if(confirm("Delete?")){
data.splice(i,1);
localStorage.setItem(KEY,JSON.stringify(data));
refresh();
}
}

function doExcel(){

const filtered=
selectedCategory==="All"
?data
:data.filter(r=>r.c===selectedCategory);

let csv="Date,Category,Description,Amount\n";

filtered.forEach(r=>{
csv+=`${r.date},${r.c},${r.d},${r.a}\n`;
});

const blob=new Blob([csv]);
const a=document.createElement("a");

a.href=URL.createObjectURL(blob);
a.download=
selectedCategory==="All"
?"KhataPro_All.csv"
:`KhataPro_${selectedCategory}.csv`;

a.click();
}

</script>

</body>
</html>
