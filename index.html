<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizHisab Fixed - Smart View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4285F4; --success: #34A853; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ‡§ä‡§™‡§∞ ‡§ï‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ */
        .header-section { flex-shrink: 0; }
        
        .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .summary-card { padding: 10px; border-radius: 10px; text-align: center; color: white; }
        .month-card { background: #4285F4; }
        .year-card { background: #34A853; }
        .val { font-size: 1.1rem; font-weight: bold; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .chart-box { text-align: center; height: 120px; }

        input, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; }

        /* ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§µ‡§æ‡§≤‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§ú‡•ã ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§π‡•ã‡§ó‡§æ */
        .history-section { flex-grow: 1; overflow-y: auto; background: white; border-radius: 12px 12px 0 0; padding: 10px; border-top: 2px solid #eee; }
        
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .history-table td { padding: 10px 5px; border-bottom: 1px solid #f8f9fa; }
        .btn-act { background: none; color: #4285F4; border: none; padding: 0; width: auto; font-size: 12px; margin-left: 10px; cursor: pointer; }
        .btn-del { color: #EA4335; }

        h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: #444; }
        .export-link { display: block; text-align: center; font-size: 12px; color: #666; text-decoration: none; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="summary-grid">
            <div class="summary-card month-card">
                <div id="mName" style="font-size: 0.65rem; opacity: 0.8;">‡§Æ‡§π‡•Ä‡§®‡§æ</div>
                <div class="val" id="monthTotal">‚Çπ0</div>
            </div>
            <div class="summary-card year-card">
                <div id="yName" style="font-size: 0.65rem; opacity: 0.8;">‡§∏‡§æ‡§≤</div>
                <div class="val" id="yearTotal">‚Çπ0</div>
            </div>
        </div>

        <div class="card charts-grid">
            <div class="chart-box"><canvas id="monthChart"></canvas></div>
            <div class="chart-box"><canvas id="yearChart"></canvas></div>
        </div>

        <div class="card">
            <h3 id="formTitle">üí∞ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç</h3>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="desc" placeholder="‡§µ‡§ø‡§µ‡§∞‡§£" style="flex: 2;">
                <input type="number" id="amt" placeholder="‡§∞‡•Å‡§™‡§Ø‡•á" style="flex: 1;">
            </div>
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="text" id="cat" placeholder="‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä" list="cat-list" style="flex: 2;">
                <button onclick="saveData()" id="saveBtn" style="flex: 1; margin: 5px 0;">‡§∏‡•á‡§µ</button>
            </div>
            <datalist id="cat-list"></datalist>
        </div>
    </div>

    <div class="history-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">üìú ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä</h3>
            <a href="#" class="export-link" onclick="exportToCSV()">Excel Export</a>
        </div>
        <table class="history-table">
            <tbody id="tableBody"></tbody>
        </table>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('biz_fixed_v7')) || [];
    let mChart, yChart;
    let editIdx = -1;

    window.onload = () => { setupCharts(); updateDisplay(); };

    function setupCharts() {
        const commonOptions = { plugins: { legend: { display: false } }, maintainAspectRatio: false };
        mChart = new Chart(document.getElementById('monthChart'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E44AD'] }] }, options: commonOptions });
        yChart = new Chart(document.getElementById('yearChart'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E44AD'] }] }, options: commonOptions });
    }

    function saveData() {
        const desc = document.getElementById('desc').value;
        const amt = parseFloat(document.getElementById('amt').value);
        const cat = document.getElementById('cat').value || "Other";
        const now = new Date();

        if(!desc || isNaN(amt)) return alert("Data fill karein!");

        const entry = { date: now.toLocaleDateString('en-IN'), month: now.getMonth(), year: now.getFullYear(), desc, amt, cat };

        if(editIdx === -1) db.push(entry);
        else { db[editIdx] = entry; editIdx = -1; document.getElementById('saveBtn').innerText = "‡§∏‡•á‡§µ"; }
        
        localStorage.setItem('biz_fixed_v7', JSON.stringify(db));
        document.getElementById('desc').value = '';
        document.getElementById('amt').value = '';
        updateDisplay();
    }

    function updateDisplay() {
        const now = new Date();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        let mTotal = 0, yTotal = 0, mData = {}, yData = {};

        db.slice().reverse().forEach((item, index) => {
            const realIdx = (db.length - 1) - index;
            tbody.innerHTML += `<tr>
                <td><b>${item.desc}</b><br><small>${item.date} | ${item.cat}</small></td>
                <td style="text-align:right">‚Çπ${item.amt}<br>
                    <button class="btn-act" onclick="edit(${realIdx})">Edit</button>
                    <button class="btn-act btn-del" onclick="del(${realIdx})">X</button>
                </td>
            </tr>`;

            if(item.year === now.getFullYear()) {
                yTotal += item.amt;
                yData[item.cat] = (yData[item.cat] || 0) + item.amt;
                if(item.month === now.getMonth()) {
                    mTotal += item.amt;
                    mData[item.cat] = (mData[item.cat] || 0) + item.amt;
                }
            }
        });

        const months = ["‡§ú‡§®‡§µ‡§∞‡•Ä", "‡§´‡§∞‡§µ‡§∞‡•Ä", "‡§Æ‡§æ‡§∞‡•ç‡§ö", "‡§Ö‡§™‡•ç‡§∞‡•à‡§≤", "‡§Æ‡§à", "‡§ú‡•Ç‡§®", "‡§ú‡•Å‡§≤‡§æ‡§à", "‡§Ö‡§ó‡§∏‡•ç‡§§", "‡§∏‡§ø‡§§‡§Ç‡§¨‡§∞", "‡§Ö‡§ï‡•ç‡§ü‡•Ç‡§¨‡§∞", "‡§®‡§µ‡§Ç‡§¨‡§∞", "‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞"];
        document.getElementById('mName').innerText = months[now.getMonth()];
        document.getElementById('yName').innerText = now.getFullYear();
        document.getElementById('monthTotal').innerText = `‚Çπ${mTotal}`;
        document.getElementById('yearTotal').innerText = `‚Çπ${yTotal}`;

        mChart.data.labels = Object.keys(mData);
        mChart.data.datasets[0].data = Object.values(mData);
        mChart.update();

        yChart.data.labels = Object.keys(yData);
        yChart.data.datasets[0].data = Object.values(yData);
        yChart.update();
    }

    function edit(idx) {
        const item = db[idx];
        document.getElementById('desc').value = item.desc;
        document.getElementById('amt').value = item.amt;
        document.getElementById('cat').value = item.cat;
        editIdx = idx;
        document.getElementById('saveBtn').innerText = "Update";
    }

    function del(idx) {
        if(confirm("Delete entry?")) { db.splice(idx, 1); localStorage.setItem('biz_fixed_v7', JSON.stringify(db)); updateDisplay(); }
    }

    function exportToCSV() {
        let csv = "Date,Category,Description,Amount\n";
        db.forEach(r => csv += `${r.date},${r.cat},${r.desc},${r.amt}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Hisab.csv';
        a.click();
    }
</script>
</body>
</html>
