<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khata-Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4285F4; --success: #34A853; --bg: #f1f5f9; }
        
        /* ‡§¨‡•â‡§°‡•Ä ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡§æ */
        html, body { 
            position: fixed; 
            width: 100%; 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: var(--bg);
            font-family: 'Segoe UI', sans-serif;
        }

        /* ‡§ä‡§™‡§∞ ‡§ï‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° ‡§è‡§∞‡§ø‡§Ø‡§æ */
        .top-fixed-area {
            position: absolute;
            top: 0;
            width: 100%;
            height: 410px; /* ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° ‡§π‡§æ‡§á‡§ü */
            padding: 10px;
            box-sizing: border-box;
            background: var(--bg);
            z-index: 100;
        }

        .app-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .card { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 8px; }
        
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .summary-card { padding: 8px; border-radius: 10px; text-align: center; color: white; }
        .month-card { background: linear-gradient(135deg, #4285F4, #1a73e8); }
        .year-card { background: linear-gradient(135deg, #34A853, #2d8a45); }
        .val { font-size: 1.1rem; font-weight: bold; }

        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 120px; }

        .input-row { display: flex; gap: 5px; margin-bottom: 5px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .save-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; }

        /* ‡§®‡•Ä‡§ö‡•á ‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ */
        .history-scroll-area {
            position: absolute;
            top: 410px; /* ‡§ú‡§π‡§æ‡§Å ‡§ä‡§™‡§∞ ‡§ï‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à */
            bottom: 0;
            width: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            padding: 15px;
            box-sizing: border-box;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }

        .history-table { width: 100%; border-collapse: collapse; }
        .history-table td { padding: 12px 5px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .btn-act { color: var(--primary); background: none; border: none; font-size: 11px; font-weight: bold; margin-left: 10px; }
        .btn-del { color: #EA4335; }
    </style>
</head>
<body>

<div class="top-fixed-area">
    <div class="app-title">KHATA-PRO</div>
    
    <div class="summary-grid">
        <div class="summary-card month-card">
            <div id="mName" style="font-size: 0.6rem; text-transform: uppercase;">‡§Æ‡§π‡•Ä‡§®‡§æ</div>
            <div class="val" id="monthTotal">‚Çπ0</div>
        </div>
        <div class="summary-card year-card">
            <div id="yName" style="font-size: 0.6rem; text-transform: uppercase;">‡§∏‡§æ‡§≤</div>
            <div class="val" id="yearTotal">‚Çπ0</div>
        </div>
    </div>

    <div class="card charts-container" style="margin-top: 10px;">
        <div><canvas id="monthChart"></canvas></div>
        <div><canvas id="yearChart"></canvas></div>
    </div>

    <div class="card">
        <div class="input-row">
            <input type="text" id="desc" placeholder="‡§ñ‡§∞‡•ç‡§ö‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£">
            <input type="number" id="amt" placeholder="‚Çπ">
        </div>
        <div class="input-row">
            <input type="text" id="cat" placeholder="‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä" list="cat-list">
            <button onclick="saveData()" id="saveBtn" class="save-btn" style="flex: 0.6;">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
        <datalist id="cat-list"></datalist>
    </div>
</div>

<div class="history-scroll-area">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0; font-size:1rem; color:#333;">üìú ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä</h3>
        <span onclick="exportCSV()" style="font-size:11px; color:var(--primary); font-weight:bold;">EXCEL EXPORT</span>
    </div>
    <table class="history-table">
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('khata_pro_v9')) || [];
    let mChart, yChart;
    let editIdx = -1;

    window.onload = () => { setupCharts(); updateDisplay(); };

    function setupCharts() {
        const opt = { plugins: { legend: { display: false } }, maintainAspectRatio: false };
        mChart = new Chart(document.getElementById('monthChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E44AD'] }] }, options: opt });
        yChart = new Chart(document.getElementById('yearChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E44AD'] }] }, options: opt });
    }

    function saveData() {
        const desc = document.getElementById('desc').value;
        const amt = parseFloat(document.getElementById('amt').value);
        const cat = document.getElementById('cat').value || "Other";
        if(!desc || isNaN(amt)) return;

        const now = new Date();
        const entry = { date: now.toLocaleDateString('en-IN'), month: now.getMonth(), year: now.getFullYear(), desc, amt, cat };

        if(editIdx === -1) db.push(entry);
        else { db[editIdx] = entry; editIdx = -1; document.getElementById('saveBtn').innerText = "‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç"; }
        
        localStorage.setItem('khata_pro_v9', JSON.stringify(db));
        document.getElementById('desc').value = '';
        document.getElementById('amt').value = '';
        updateDisplay();
    }

    function updateDisplay() {
        const now = new Date();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        let mTotal = 0, yTotal = 0, mData = {}, yData = {};

        db.slice().reverse().forEach((item, index) => {
            const realIdx = (db.length - 1) - index;
            tbody.innerHTML += `<tr>
                <td><b>${item.desc}</b><br><small style="color:#888">${item.date} | ${item.cat}</small></td>
                <td style="text-align:right">‚Çπ${item.amt}<br>
                    <button class="btn-act" onclick="edit(${realIdx})">Edit</button>
                    <button class="btn-act btn-del" onclick="del(${realIdx})">Del</button>
                </td>
            </tr>`;

            if(item.year === now.getFullYear()) {
                yTotal += item.amt;
                yData[item.cat] = (yData[item.cat] || 0) + item.amt;
                if(item.month === now.getMonth()) {
                    mTotal += item.amt;
                    mData[item.cat] = (mData[item.cat] || 0) + item.amt;
                }
            }
        });

        document.getElementById('monthTotal').innerText = `‚Çπ${mTotal}`;
        document.getElementById('yearTotal').innerText = `‚Çπ${yTotal}`;
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        document.getElementById('mName').innerText = months[now.getMonth()];
        document.getElementById('yName').innerText = now.getFullYear();

        mChart.data.labels = Object.keys(mData);
        mChart.data.datasets[0].data = Object.values(mData);
        mChart.update();

        yChart.data.labels = Object.keys(yData);
        yChart.data.datasets[0].data = Object.values(yData);
        yChart.update();
    }

    function edit(idx) {
        const item = db[idx];
        document.getElementById('desc').value = item.desc;
        document.getElementById('amt').value = item.amt;
        document.getElementById('cat').value = item.cat;
        editIdx = idx;
        document.getElementById('saveBtn').innerText = "UPDATE";
    }

    function del(idx) {
        if(confirm("‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç?")) { db.splice(idx, 1); localStorage.setItem('khata_pro_v9', JSON.stringify(db)); updateDisplay(); }
    }

    function exportCSV() {
        let csv = "Date,Category,Description,Amount\n";
        db.forEach(r => csv += `${r.date},${r.cat},${r.desc},${r.amt}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'KhataPro_Backup.csv';
        a.click();
    }
</script>
</body>
</html>
