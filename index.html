<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BizHisab Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4285F4; --success: #34A853; --bg: #f1f5f9; }
        
        /* ‡§™‡•Ç‡§∞‡•á ‡§™‡•á‡§ú ‡§ï‡•ã ‡§´‡§ø‡§ï‡•ç‡§∏ ‡§ï‡§∞‡§®‡§æ ‡§§‡§æ‡§ï‡§ø ‡§µ‡§π ‡§≠‡§æ‡§ó‡•á ‡§®‡§π‡•Ä‡§Ç */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; /* ‡§¨‡§æ‡§π‡§∞‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§¨‡§Ç‡§¶ */
            background: var(--bg);
            font-family: 'Segoe UI', sans-serif;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ‡§ä‡§™‡§∞ ‡§ï‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ (Fixed) */
        .top-section {
            flex-shrink: 0;
            padding: 10px;
            background: var(--bg);
            z-index: 10;
        }

        .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 8px; }
        
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .summary-card { padding: 10px; border-radius: 10px; text-align: center; color: white; }
        .month-card { background: #4285F4; }
        .year-card { background: #34A853; }
        .val { font-size: 1.1rem; font-weight: bold; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 130px; }
        
        /* ‡§á‡§®‡§™‡•Å‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ */
        .input-group { display: flex; gap: 5px; margin-bottom: 5px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡•ã ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§Ö‡§™‡§®‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§π‡•ã‡§ó‡§æ */
        .history-section {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* ‡§∏‡•ç‡§Æ‡•Ç‡§• ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ */
            background: white;
            padding: 15px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }

        .history-table { width: 100%; border-collapse: collapse; }
        .history-table td { padding: 12px 5px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .btn-edit { color: var(--primary); background: none; border: none; font-size: 12px; margin-left: 10px; }
        .btn-del { color: #EA4335; background: none; border: none; font-size: 12px; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="top-section">
        <div class="summary-grid">
            <div class="summary-card month-card">
                <div id="mName" style="font-size: 0.7rem;">‡§Æ‡§π‡•Ä‡§®‡§æ</div>
                <div class="val" id="monthTotal">‚Çπ0</div>
            </div>
            <div class="summary-card year-card">
                <div id="yName" style="font-size: 0.7rem;">‡§∏‡§æ‡§≤</div>
                <div class="val" id="yearTotal">‚Çπ0</div>
            </div>
        </div>

        <div class="card charts-grid" style="margin-top: 10px;">
            <div style="height: 100%;"><canvas id="monthChart"></canvas></div>
            <div style="height: 100%;"><canvas id="yearChart"></canvas></div>
        </div>

        <div class="card">
            <div class="input-group">
                <input type="text" id="desc" placeholder="‡§ñ‡§∞‡•ç‡§ö‡§æ (‡§â‡§¶‡§æ. ‡§™‡•á‡§ü‡•ç‡§∞‡•ã‡§≤)">
                <input type="number" id="amt" placeholder="‚Çπ">
            </div>
            <div class="input-group">
                <input type="text" id="cat" placeholder="‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä" list="cat-list">
                <button onclick="saveData()" id="saveBtn" style="flex: 0.5;">‡§∏‡•á‡§µ</button>
            </div>
            <datalist id="cat-list"></datalist>
        </div>
    </div>

    <div class="history-section" id="scrollArea">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0; font-size:1rem; color:#333;">üìú ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä</h3>
            <span onclick="exportToCSV()" style="font-size:12px; color:var(--primary); cursor:pointer;">Excel Export</span>
        </div>
        <table class="history-table">
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('biz_stable_v8')) || [];
    let mChart, yChart;
    let editIdx = -1;

    // ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§∏‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
    window.onload = () => {
        setupCharts();
        updateDisplay();
        // ‡§ë‡§ü‡•ã-‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡•ã‡§ï‡§∏ ‡§π‡§ü‡§æ‡§®‡§æ
        document.activeElement.blur();
    };

    function setupCharts() {
        const options = { plugins: { legend: { display: false } }, maintainAspectRatio: false };
        mChart = new Chart(document.getElementById('monthChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E44AD'] }] }, options });
        yChart = new Chart(document.getElementById('yearChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E44AD'] }] }, options });
    }

    function saveData() {
        const desc = document.getElementById('desc').value;
        const amt = parseFloat(document.getElementById('amt').value);
        const cat = document.getElementById('cat').value || "Other";
        if(!desc || isNaN(amt)) return;

        const now = new Date();
        const entry = { date: now.toLocaleDateString('en-IN'), month: now.getMonth(), year: now.getFullYear(), desc, amt, cat };

        if(editIdx === -1) db.push(entry);
        else { db[editIdx] = entry; editIdx = -1; document.getElementById('saveBtn').innerText = "‡§∏‡•á‡§µ"; }
        
        localStorage.setItem('biz_stable_v8', JSON.stringify(db));
        document.getElementById('desc').value = '';
        document.getElementById('amt').value = '';
        updateDisplay();
    }

    function updateDisplay() {
        const now = new Date();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        let mTotal = 0, yTotal = 0, mData = {}, yData = {};

        db.slice().reverse().forEach((item, index) => {
            const realIdx = (db.length - 1) - index;
            tbody.innerHTML += `<tr>
                <td><b>${item.desc}</b><br><small style="color:#888">${item.date} | ${item.cat}</small></td>
                <td style="text-align:right">‚Çπ${item.amt}<br>
                    <button class="btn-edit" onclick="edit(${realIdx})">Edit</button>
                    <button class="btn-del" onclick="del(${realIdx})">X</button>
                </td>
            </tr>`;

            if(item.year === now.getFullYear()) {
                yTotal += item.amt;
                yData[item.cat] = (yData[item.cat] || 0) + item.amt;
                if(item.month === now.getMonth()) {
                    mTotal += item.amt;
                    mData[item.cat] = (mData[item.cat] || 0) + item.amt;
                }
            }
        });

        document.getElementById('monthTotal').innerText = `‚Çπ${mTotal}`;
        document.getElementById('yearTotal').innerText = `‚Çπ${yTotal}`;
        const months = ["‡§ú‡§®‡§µ‡§∞‡•Ä", "‡§´‡§∞‡§µ‡§∞‡•Ä", "‡§Æ‡§æ‡§∞‡•ç‡§ö", "‡§Ö‡§™‡•ç‡§∞‡•à‡§≤", "‡§Æ‡§à", "‡§ú‡•Ç‡§®", "‡§ú‡•Å‡§≤‡§æ‡§à", "‡§Ö‡§ó‡§∏‡•ç‡§§", "‡§∏‡§ø‡§§‡§Ç‡§¨‡§∞", "‡§Ö‡§ï‡•ç‡§ü‡•Ç‡§¨‡§∞", "‡§®‡§µ‡§Ç‡§¨‡§∞", "‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞"];
        document.getElementById('mName').innerText = months[now.getMonth()];
        document.getElementById('yName').innerText = now.getFullYear();

        mChart.data.labels = Object.keys(mData);
        mChart.data.datasets[0].data = Object.values(mData);
        mChart.update();

        yChart.data.labels = Object.keys(yData);
        yChart.data.datasets[0].data = Object.values(yData);
        yChart.update();
    }

    function edit(idx) {
        const item = db[idx];
        document.getElementById('desc').value = item.desc;
        document.getElementById('amt').value = item.amt;
        document.getElementById('cat').value = item.cat;
        editIdx = idx;
        document.getElementById('saveBtn').innerText = "Update";
        // ‡§ä‡§™‡§∞ ‡§ï‡•Ä ‡§§‡§∞‡§´ ‡§´‡•ã‡§ï‡§∏ ‡§≤‡•á ‡§ú‡§æ‡§®‡§æ
        window.scrollTo(0,0);
    }

    function del(idx) {
        if(confirm("Delete?")) { db.splice(idx, 1); localStorage.setItem('biz_stable_v8', JSON.stringify(db)); updateDisplay(); }
    }

    function exportToCSV() {
        let csv = "Date,Category,Description,Amount\n";
        db.forEach(r => csv += `${r.date},${r.cat},${r.desc},${r.amt}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Hisab_Backup.csv';
        a.click();
    }
</script>
</body>
</html>
