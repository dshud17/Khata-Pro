<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Khata-Pro</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--p:#4285F4;--r:#EA4335;}
body{margin:0;padding:10px;background:#f8fafc;font-family:Segoe UI}
.app-title{text-align:center;font-weight:800;color:var(--p)}
.card{background:#fff;padding:15px;border-radius:15px;margin-bottom:15px}

.summary{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.box{color:#fff;text-align:center;padding:15px;border-radius:12px}
.m{background:#2563eb}
.y{background:#16a34a}

.input-row{display:flex;gap:8px;margin-bottom:8px}
input{flex:1;padding:12px;border-radius:8px;border:1px solid #ddd}
button{padding:12px;border:none;border-radius:8px;font-weight:bold}
.save{background:#4285F4;color:#fff}

.analysis{background:#edf2f7;padding:15px;border-radius:18px}
.grid{display:grid;grid-template-columns:1fr 1fr}
.chart{height:100px;width:100px;margin:auto}

.history-title{
display:flex;justify-content:space-between;
font-weight:800;border-bottom:2px solid #eee}

td{padding:10px;border-bottom:1px solid #eee}
.amt{text-align:right;font-weight:800}
.act{border:none;background:none;color:#4285F4}
.del{color:red}
</style>
</head>

<body>

<div class="app-title">KHATA-PRO</div>

<div class="summary">
<div class="box m"><div id="mLabel"></div><div id="mTotal">₹0</div></div>
<div class="box y"><div id="yLabel"></div><div id="yTotal">₹0</div></div>
</div>

<div class="card">
<div class="input-row">
<input id="desc" placeholder="Item">
<input id="amt" type="number" placeholder="Amount">
</div>

<div class="input-row">
<input id="cat" placeholder="Category">
</div>

<div class="input-row">
<button onclick="save()" id="saveBtn" class="save">SAVE</button>
</div>
</div>

<div class="analysis">
<div class="grid">
<div class="chart"><canvas id="mChart"></canvas></div>
<div class="chart"><canvas id="yChart"></canvas></div>
</div>
</div>

<div class="card">
<div class="history-title">
<span>History (<span id="filterName">All</span>)</span>
<span onclick="downloadCSV()">DOWNLOAD</span>
</div>
<table width="100%">
<tbody id="tbody"></tbody>
</table>
</div>

<script>

const KEY="khata_pro_v14_final";

let data=JSON.parse(localStorage.getItem(KEY))||[];
let selectedCategory="All";
let editIndex=-1;

let mc,yc;

window.onload=()=>{
initCharts();
refresh();
};

function initCharts(){

const opt={
plugins:{legend:{display:false}},
cutout:'70%',
onClick:(evt,el,chart)=>{
if(el.length){
selectedCategory=chart.data.labels[el[0].index];
}else selectedCategory="All";
refresh();
}
};

mc=new Chart(mChart,{
type:'doughnut',
data:{labels:[],datasets:[{data:[],
backgroundColor:['#4285F4','#34A853','#FBBC05','#EA4335','#8E44AD']}]},
options:opt
});

yc=new Chart(yChart,{
type:'doughnut',
data:{labels:[],datasets:[{data:[],
backgroundColor:['#4285F4','#34A853','#FBBC05','#EA4335','#8E44AD']}]},
options:opt
});
}

function save(){

const d=desc.value;
const a=parseFloat(amt.value);
const c=cat.value||"Other";

if(!d||isNaN(a))return alert("Fill details");

const now=new Date();

const entry={
id:Date.now(),
date:now.toLocaleDateString('en-IN'),
mo:now.getMonth(),
yr:now.getFullYear(),
d,a,c
};

if(editIndex===-1)
data.push(entry);
else{
data[editIndex]=entry;
editIndex=-1;
saveBtn.innerText="SAVE";
}

localStorage.setItem(KEY,JSON.stringify(data));

desc.value="";
amt.value="";
cat.value="";

refresh();
}

function refresh(){

tbody.innerHTML="";

let ms=0,ys=0,mg={},yg={};
const now=new Date();

const filtered=
selectedCategory==="All"
?data
:data.filter(x=>x.c===selectedCategory);

filtered.slice().reverse().forEach(item=>{

const realIndex=data.indexOf(item);

tbody.innerHTML+=`
<tr>
<td>
<b>${item.d}</b><br>
${item.date} | ${item.c}<br>
<button class="act" onclick="edit(${realIndex})">Edit</button>
<button class="act del" onclick="del(${realIndex})">Del</button>
</td>
<td class="amt">₹${item.a}</td>
</tr>`;

if(item.yr===now.getFullYear){
ys+=item.a;
yg[item.c]=(yg[item.c]||0)+item.a;

if(item.mo===now.getMonth()){
ms+=item.a;
mg[item.c]=(mg[item.c]||0)+item.a;
}
}
});

mTotal.innerText="₹"+ms;
yTotal.innerText="₹"+ys;
filterName.innerText=selectedCategory;

updateChart(mc,mg);
updateChart(yc,yg);
}

function updateChart(c,d){
c.data.labels=Object.keys(d);
c.data.datasets[0].data=Object.values(d);
c.update();
}

function edit(i){
const r=data[i];
desc.value=r.d;
amt.value=r.a;
cat.value=r.c;
editIndex=i;
saveBtn.innerText="UPDATE";
window.scrollTo(0,0);
}

function del(i){
if(confirm("Delete entry?")){
data.splice(i,1);
localStorage.setItem(KEY,JSON.stringify(data));
refresh();
}
}

function downloadCSV(){

const filtered=
selectedCategory==="All"
?data
:data.filter(r=>r.c===selectedCategory);

let csv="Date,Category,Description,Amount\n";

filtered.forEach(r=>{
csv+=`${r.date},${r.c},${r.d},${r.a}\n`;
});

const blob=new Blob([csv]);
const a=document.createElement("a");

a.href=URL.createObjectURL(blob);

a.download=
selectedCategory==="All"
?"KhataPro_All.csv"
:`KhataPro_${selectedCategory}.csv`;

a.click();
}

</script>

</body>
</html>
